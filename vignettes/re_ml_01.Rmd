---
title: "Report_5"
author: "Dario Maccioni"
date: "`r Sys.Date()`"
output: html_document
---

```{r message = FALSE}
half_hourly_fluxes <- readr::read_csv("https://raw.githubusercontent.com/geco-bern/agds/main/data/df_for_stepwise_regression.csv") # Loading the dataset (.csv) into R and creating a table
```

```{r}
visdat::vis_miss(half_hourly_fluxes) # Checking if any data in the dataset is missing
```

```{r}
half_hourly_fluxes_fixed <- stats::na.omit(half_hourly_fluxes) # Deleting all rows with at least one value which equals "NA"
```



```{r}
library(ggplot2)
# Data cleaning: looks ok, no obviously bad data
# no long tail, therefore no further target engineering
half_hourly_fluxes |> 
  ggplot(aes(x = GPP_NT_VUT_REF, y = ..count..)) + 
  geom_histogram()
```

```{r}
library(rsample)
library(tidyr)
library(caret)
library(recipes)
# Data splitting
set.seed(1982)  # for reproducibility
split <- rsample::initial_split(half_hourly_fluxes_fixed, prop = 0.7, strata = "VPD_F")
half_hourly_fluxes_train <- rsample::training(split)
half_hourly_fluxes_test <- rsample::testing(split)

# Model and pre-processing formulation, use all variables but LW_IN_F
pp <- recipes::recipe(GPP_NT_VUT_REF ~ SW_IN_F + VPD_F + TA_F, 
                      data = half_hourly_fluxes_train |> drop_na()) |> 
  recipes::step_BoxCox(all_predictors()) |> 
  recipes::step_center(all_numeric(), -all_outcomes()) |>
  recipes::step_scale(all_numeric(), -all_outcomes())

# Fit linear regression model
mod_lm <- caret::train(
  pp, 
  data = half_hourly_fluxes_train |> drop_na(), 
  method = "lm",
  trControl = caret::trainControl(method = "none"),
  metric = "RMSE"
)

# Fit KNN model
mod_knn <- caret::train(
  pp, 
  data = half_hourly_fluxes_train, 
  method = "knn",
  trControl = caret::trainControl(method = "none"),
  tuneGrid = data.frame(k = 8),
  metric = "RMSE"
)
```

```{r}
source("../Functions/large_file.R")
```

```{r}

# Linear Regression
eval_model(mod = mod_lm, df_train = daily_fluxes_train, df_test = daily_fluxes_test)

```

```{r}
# KNN
eval_model(mod = mod_knn, df_train = daily_fluxes_train, df_test = daily_fluxes_test)
```

```{r}
library(ggplot2)

# create a dataframe with the dates and observed GPP
observed <- data.frame(Date = half_hourly_fluxes_fixed$TIMESTAMP, GPP = half_hourly_fluxes_fixed$GPP_NT_VUT_REF)

# add columns with modelled GPP for linear regression and KNN
observed$lm <- predict(mod_lm, newdata = half_hourly_fluxes_fixed)
observed$knn <- predict(mod_knn, newdata = half_hourly_fluxes_fixed)

# create a line plot for observed and modelled GPP for linear regression
ggplot(observed, aes(x = Date)) +
  geom_line(aes(y = GPP, color = "Observed")) +
  geom_line(aes(y = lm, color = "Linear Regression")) +
  labs(x = "Date", y = "GPP", color = "Model") +
  ggtitle("Observed and Modelled GPP for Linear Regression")

# create a line plot for observed and modelled GPP for KNN
ggplot(observed, aes(x = Date)) +
  geom_line(aes(y = GPP, color = "Observed")) +
  geom_line(aes(y = knn, color = "KNN")) +
  labs(x = "Date", y = "GPP", color = "Model") +
  ggtitle("Observed and Modelled GPP for KNN")

```

